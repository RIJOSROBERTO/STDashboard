/*! STDashboard 2017-04-27 */
var config=require("./config.js"),request=require("request"),express=require("express"),OAuth=require("oauth"),OAuth2=OAuth.OAuth2;if(app=express(),"bearer"in config.oauth&&""!==config.oauth.bearer)app.get("/",function(a,b){var c={uri:config.oauth.endpoint+"/list",headers:{Authorization:"Bearer "+config.oauth.bearer}};request(c,function(a,c,d){b.send("<pre>"+d+"</pre>")})}),app.get("/:id/:cmd",function(a,b){if(["on","off"].indexOf(a.params.cmd)<0)return void b.status(400).send("Invalid Command: "+a.params.cmd);var c={method:"GET",uri:config.oauth.endpoint+"/cmd/"+a.params.id+"/"+a.params.cmd,headers:{Authorization:"Bearer "+config.oauth.bearer}};request(c,function(a,c,d){b.send("<pre>"+d+"</pre>")})}),app.listen(3e3),console.log("Bearer defined, assuming valid. Starting server on localhost:3000");else{var endpoints_uri=config.oauth.serverSite+"/api/smartapps/endpoints",oauth2=new OAuth2(config.oauth.clientID,config.oauth.clientSecret,config.oauth.serverSite,"/oauth/authorize","/oauth/token",null),authorization_uri=oauth2.getAuthorizeUrl({redirect_uri:"http://localhost:3000/callback",scope:"app",state:"3(#0/!~5467",response_type:"code"});app.get("/auth",function(a,b){b.redirect(authorization_uri)}),app.get("/callback",function(a,b){function c(a,c,d,e){if(a)return console.log("Access Token Error ",a,a.message),console.log("Results Error ",e,c),void b.end(a.data);if(e.error)return console.log(e),void b.end(JSON.stringify(e));var f=c;request({method:"GET",uri:endpoints_uri+"?access_token="+c},function(a,c,d){var e=JSON.parse(d),g=e[0].uri;b.send("<pre>"+g+"</pre><br><pre>Bearer "+f+"</pre><br /><pre>"+d+"</pre>")})}var d=a.query.code;console.log("/callback got code "+d),oauth2.getOAuthAccessToken(d,{code:d,redirect_uri:"http://localhost:3000/callback",grant_type:"authorization_code"},c)}),app.get("/",function(a,b){b.send('<a href="/auth">Connect with SmartThings</a>')}),app.listen(3e3),console.log("Bearer not defined, starting config server on localhost:3000")}